language: cpp
cache: 
  directories:
    - $HOME/build-cache
    - $HOME/Library/Caches/Homebrew
    - /usr/local/Homebrew
  ccache: true  
before_cache:
- if [ "${TRAVIS_OS_NAME}" = "osx" ]; then brew cleanup; fi
- if [ "${TRAVIS_OS_NAME}" = "osx" ]; then find /usr/local/Homebrew \! -regex ".+\.git.+" -delete; fi    
git:
    submodules: false
matrix:
  include:
    #- os: linux
     # env: NAME="linux appimage"
     # sudo: required
     # dist: trusty
     # services: docker
     # addons:
     #   apt:
     #     packages:
     #       - p7zip-full
     # install: 
     #  - docker pull quriouspixel/yuzu:latest
     # script: 
     #  - "./.travis/appimage/build.sh"
     # after_success:
     # - ls -al artifacts/
     # - cd artifacts/
     # - wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
     # - chmod a+x upload.sh
     # - bash upload.sh yuzu-x86_64.AppImage* 
      #branches:
  #except:
    #- /^(?i:continuous.*)$/
    #- os: linux
    # env: NAME="clang-format"
    #  sudo: required
    #  dist: trusty
    #  services: docker
    #  install: "./.travis/clang-format/deps.sh"
    #  script: "./.travis/clang-format/build.sh"
    #- os: linux
    #  env: NAME="linux build"
    #  sudo: required
    #  dist: trusty
    #  services: docker
    #  addons:
    #    apt:
    #      packages:
    #        - p7zip-full
    #  install: "./.travis/linux/deps.sh"
    #  script: "./.travis/linux/build.sh"
    #  after_success: "./.travis/linux/upload.sh"
    #  cache: ccache
    - os: osx
      env: NAME="macos build"
      sudo: false
      osx_image: xcode12
      addons:
        homebrew:
          packages:
          - p7zip 
          - sdl2 
          - ccache 
          - ninja 
          - ffmpeg 
          - pulseaudio
          - mbedtls 
          - gpm 
          - pkgconfig
          - qt 
          - openssl 
          - zstd
          - boost
          - libzip
          - clang-format 
          - gcc@10
          #update: true
      install:
      #- "./.travis/macos/deps.sh"
      - curl -sLO https://github.com/phracker/MacOSX-SDKs/releases/download/10.15/MacOSX10.14.sdk.tar.xz
      - tar -xf MacOSX10.14.sdk.tar.xz -C /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
      - plutil -convert xml1 /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist
      - sed -i -e 's|<string>10.15</string>|<string>10.14</string>|g' /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist
      - cat /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist
      - plutil -convert binary1 /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist
      - rm /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk
      - mv /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk
      - mv /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
      - ls -al /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
      - pip3 install macpack
      - pip3 install conan      
      #install: "./.travis/macos/deps.sh"
      script:
      - "./.travis/macos/build.sh"
      after_success: "./.travis/macos/upload.sh"
    #  cache: ccache
    #- os: linux
    #  env: NAME="MinGW build"
    #  sudo: required
    #  dist: trusty
    #  services: docker
    #  addons:
    #    apt:
    #      packages:
    #        - p7zip-full
    #  install: "./.travis/linux-mingw/deps.sh"
    #  script: "./.travis/linux-mingw/build.sh"
    #  after_success: "./.travis/linux-mingw/upload.sh"
    #  cache: ccache

deploy:
  provider: script
  script: bash .travis/macos/deploy.sh
  api_key: $GITHUB_TOKEN
#  secure: 
  file_glob: true
  file: "artifacts/*"
  skip_cleanup: true
  on:
    branch: mac-1013-12

#notifications:
#  webhooks:
#    urls:
#      - https://api.yuzu-emu.org/code/travis/notify
